name: Sync Project Status

on:
  issues:
    types: [opened, assigned, closed, reopened]
  pull_request:
    types: [opened, ready_for_review, converted_to_draft, closed]
  pull_request_review:
    types: [submitted]

jobs:
  sync-status:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------
      # Generate short-lived GitHub App token
      # ---------------------------------------
      - name: Generate org app token
        id: app
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PEM }}

      # ---------------------------------------
      # Decide which Status to apply
      # ---------------------------------------
      - name: Decide desired status
        id: decide
        env:
          EVENT_NAME: ${{ github.event_name }}
          ACTION: ${{ github.event.action }}
          IS_DRAFT: ${{ github.event.pull_request.draft }}
          REVIEW_STATE: ${{ github.event.review.state }}
          REVIEW_CONCLUSION: ${{ github.event.review.state }}
        run: |
          set -e
          desired=""

          # =======================================================
          # Item added to project (handled via "opened" events)
          #   - Issue opened → Backlog
          #   - PR opened → In Review or In Progress (draft)
          # =======================================================
          case "$EVENT_NAME" in
            issues)
              case "$ACTION" in
                opened) desired="Backlog" ;;                # Item added to project → Backlog
                assigned) desired="In Progress" ;;          # When assigned → In Progress
                closed) desired="Done" ;;                   # Item closed → Done
                reopened) desired="Ready" ;;                # Item reopened → Ready
              esac
              ;;
            pull_request)
              case "$ACTION" in
                opened)
                  if [ "$IS_DRAFT" = "true" ]; then
                    desired="In Progress"                   # Draft PR → In Progress
                  else
                    desired="In Review"                     # PR opened → In Review
                  fi
                  ;;
                ready_for_review) desired="In Review" ;;     # PR ready → In Review
                converted_to_draft) desired="In Progress" ;; # PR converted back to draft → In Progress
                closed) desired="Done" ;;                    # Pull request merged/closed → Done
              esac
              ;;
            pull_request_review)
          
              # =======================================================
              # Code changes requested
              #   - When reviewer requests changes → Blocked
              # Code review approved
              #   - When review approved → Done
              # =======================================================
              if [ "$REVIEW_STATE" = "changes_requested" ]; then
                desired="Blocked"
              elif [ "$REVIEW_STATE" = "approved" ]; then
                desired="Done"
              fi
              ;;
          esac

          echo "desired=$desired" >> $GITHUB_OUTPUT

      # ---------------------------------------
      # Skip if nothing to update
      # ---------------------------------------
      - name: Skip if nothing to do
        if: ${{ steps.decide.outputs.desired == '' }}
        run: echo "No status change needed for this event."

      # ---------------------------------------
      # Update Project Status field via GraphQL
      # ---------------------------------------
      - name: Set Status in Project
        if: ${{ steps.decide.outputs.desired != '' }}
        env:
          GH_TOKEN: ${{ steps.app.outputs.token }}
          ORG: next-wave-dev-org
          PROJECT_NUMBER: 6
          DESIRED: ${{ steps.decide.outputs.desired }}
          ISSUE_NODE_ID: ${{ github.event.issue.node_id }}
          PR_NODE_ID: ${{ github.event.pull_request.node_id }}
        run: |
          set -e

          # Fetch Project + Status field + options
          gh api graphql -f query='
            query($org:String!, $number:Int!){
              organization(login:$org){
                projectV2(number:$number){
                  id
                  fields(first:50){
                    nodes{
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options { id name }
                      }
                    }
                  }
                }
              }
            }' -F org=$ORG -F number=$PROJECT_NUMBER > project.json

          PROJECT_ID=$(jq -r '.data.organization.projectV2.id' project.json)
          STATUS_FIELD_ID=$(jq -r '.data.organization.projectV2.fields.nodes[] | select(.name=="Status") | .id' project.json)
          OPTION_ID=$(jq -r --arg n "$DESIRED" '.data.organization.projectV2.fields.nodes[] | select(.name=="Status") | .options[] | select(.name==$n) | .id' project.json)

          # Determine content node id (issue or PR)
          CONTENT_ID="${PR_NODE_ID:-$ISSUE_NODE_ID}"

          # Try to find an existing item (first 100)
          gh api graphql -f query='
            query($org:String!, $number:Int!){
              organization(login:$org){
                projectV2(number:$number){
                  items(first:100){
                    nodes{
                      id
                      content { __typename ... on Issue { id } ... on PullRequest { id } }
                    }
                  }
                }
              }
            }' -F org=$ORG -F number=$PROJECT_NUMBER > items.json

          ITEM_ID=$(jq -r --arg cid "$CONTENT_ID" '
            .data.organization.projectV2.items.nodes[]
            | select(.content.id==$cid) | .id' items.json)

          # Add if missing
          if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" = "null" ]; then
            gh api graphql -f query='
              mutation($project:ID!, $content:ID!){
                addProjectV2ItemById(input:{projectId:$project, contentId:$content}) {
                  item { id }
                }
              }' -F project=$PROJECT_ID -F content=$CONTENT_ID > add.json
            ITEM_ID=$(jq -r '.data.addProjectV2ItemById.item.id' add.json)
          fi

          # Update Status
          gh api graphql -f query='
            mutation($project:ID!, $item:ID!, $field:ID!, $option:String!){
              updateProjectV2ItemFieldValue(input:{
                projectId:$project,
                itemId:$item,
                fieldId:$field,
                value:{ singleSelectOptionId:$option }
              }) { clientMutationId }
            }' \
            -F project=$PROJECT_ID \
            -F item=$ITEM_ID \
            -F field=$STATUS_FIELD_ID \
            -F option=$OPTION_ID

          echo "Set Status => $DESIRED"
