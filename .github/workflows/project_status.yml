name: Sync Project Status

on:
  issues:
    types: [opened, assigned, closed, reopened]
  pull_request:
    types: [opened, ready_for_review, converted_to_draft, closed]

jobs:
  sync-status:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------
      # Generate short-lived GitHub App token
      # ---------------------------------------
      - name: Generate org app token
        id: app
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PEM }}

      # ---------------------------------------
      # Decide which Status to apply
      # ---------------------------------------
      - name: Decide desired status
        id: decide
        env:
          EVENT_NAME: ${{ github.event_name }}
          ACTION: ${{ github.event.action }}
          IS_DRAFT: ${{ github.event.pull_request.draft }}
          PR_MERGED: ${{ github.event.pull_request.merged }}
        run: |
          set -e
          desired=""

          # =======================================================
          # Item added to project (handled via "opened" events)
          #   - Issue opened → Backlog
          #   - Issue assigned → In Progress
          #   - Issue closed → Done
          #   - Issue reopened → Ready
          # =======================================================
          case "$EVENT_NAME" in
            issues)
              case "$ACTION" in
                opened)   desired="Backlog" ;;
                assigned) desired="In Progress" ;;
                closed)   desired="Done" ;;
                reopened) desired="Ready" ;;
              esac
              ;;
            pull_request)
              case "$ACTION" in
                opened)
                  if [ "$IS_DRAFT" = "true" ]; then
                    desired="In Progress"                 # Draft PR → In Progress
                  else
                    desired="In Review"                   # PR opened → In Review
                  fi
                  ;;
                ready_for_review)   desired="In Review" ;; # PR ready → In Review
                converted_to_draft) desired="In Progress" ;; # Back to draft → In Progress
                closed)
                  # Do NOT set status on close unless merged.
                  if [ "$PR_MERGED" = "true" ]; then
                    desired="Done"                        # Only on merge → Done
                  else
                    desired=""                            # Closed w/o merge → no change
                  fi
                  ;;
              esac
              ;;
          esac

          echo "desired=$desired" >> $GITHUB_OUTPUT

      # ---------------------------------------
      # Skip if nothing to update
      # ---------------------------------------
      - name: Skip if nothing to do
        if: ${{ steps.decide.outputs.desired == '' }}
        run: echo "No status change needed for this event."

      # ---------------------------------------
      # Update Project Status field via GraphQL
      # (robust: resolve IDs and send JSON variables)
      # ---------------------------------------
      - name: Set Status in Project
        if: ${{ steps.decide.outputs.desired != '' }}
        env:
          GH_TOKEN: ${{ steps.app.outputs.token }}
          ORG: next-wave-dev-org
          PROJECT_NUMBER: 6
          DESIRED: ${{ steps.decide.outputs.desired }}
          ISSUE_NODE_ID: ${{ github.event.issue.node_id }}
          PR_NODE_ID: ${{ github.event.pull_request.node_id }}
        run: |
          set -e

          # Fetch Project + Status field + options
          gh api graphql -f query='
            query($org:String!, $number:Int!){
              organization(login:$org){
                projectV2(number:$number){
                  id
                  fields(first:100){
                    nodes{
                      id
                      name
                      dataType
                      ... on ProjectV2SingleSelectField {
                        options { id name }
                      }
                    }
                  }
                }
              }
            }' -F org="$ORG" -F number="$PROJECT_NUMBER" > project.json

          PROJECT_ID=$(jq -r '.data.organization.projectV2.id' project.json)
          STATUS_FIELD_ID=$(jq -r '.data.organization.projectV2.fields.nodes[] | select(.name=="Status") | .id' project.json)
          OPTION_ID=$(jq -r --arg n "$DESIRED" '.data.organization.projectV2.fields.nodes[] | select(.name=="Status") | .options[] | select(.name==$n) | .id' project.json)

          # Guards: ensure we have string-like IDs (not empty/numeric)
          req() { test -n "$1" && [[ ! "$1" =~ ^[0-9]+$ ]] || { echo "::error ::Missing or numeric ID for $2"; cat project.json; exit 1; }; }
          req "$PROJECT_ID" "PROJECT_ID"
          req "$STATUS_FIELD_ID" "STATUS_FIELD_ID"
          req "$OPTION_ID" "OPTION_ID for '$DESIRED'"

          # Determine content node id (issue or PR)
          CONTENT_ID="${PR_NODE_ID:-$ISSUE_NODE_ID}"
          if [ -z "$CONTENT_ID" ]; then
            echo "::warning ::No content node id for this event; nothing to update."
            exit 0
          fi

          # Try to find an existing item (first 100)
          gh api graphql -f query='
            query($org:String!, $number:Int!){
              organization(login:$org){
                projectV2(number:$number){
                  items(first:100){
                    nodes{
                      id
                      content { __typename ... on Issue { id } ... on PullRequest { id } }
                    }
                  }
                }
              }
            }' -F org="$ORG" -F number="$PROJECT_NUMBER" > items.json

          ITEM_ID=$(jq -r --arg cid "$CONTENT_ID" \
            '.data.organization.projectV2.items.nodes[] | select(.content.id==$cid) | .id' items.json)

          # Add if missing
          if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" = "null" ]; then
            VARS=$(jq -nc --arg project "$PROJECT_ID" --arg content "$CONTENT_ID" \
              '{project:$project, content:$content}')
            gh api graphql \
              -f query='
                mutation($project:ID!, $content:ID!){
                  addProjectV2ItemById(input:{projectId:$project, contentId:$content}) {
                    item { id }
                  }
                }' \
              -f variables="$VARS" > add.json
            ITEM_ID=$(jq -r '.data.addProjectV2ItemById.item.id' add.json)
          fi

          # Update Status (JSON variables to keep strings as strings)
          VARS=$(jq -nc \
            --arg project "$PROJECT_ID" \
            --arg item    "$ITEM_ID" \
            --arg field   "$STATUS_FIELD_ID" \
            --arg option  "$OPTION_ID" \
            '{project:$project, item:$item, field:$field, option:$option}')

          gh api graphql \
            -f query='
              mutation($project:ID!, $item:ID!, $field:ID!, $option:String!) {
                updateProjectV2ItemFieldValue(input:{
                  projectId:$project,
                  itemId:$item,
                  fieldId:$field,
                  value:{ singleSelectOptionId:$option }
                }) { projectV2Item { id } }
              }' \
            -f variables="$VARS"

          echo "Set Status => $DESIRED"
